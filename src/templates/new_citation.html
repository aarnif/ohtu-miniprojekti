{% extends "layout.html" %} {% block title %} Add new citation {% endblock %} {%
block page_title %} Add new citation {% endblock %} {% block body %}

<form action="/create_citation" method="post">
  <h3>Citation:</h3>

  <div class="form-items">
    <div id="doi-message"></div>

    <label for="doi-fetch"
      >Fetch info from DOI:
      <input
        id="doi-fetch"
        type="text"
        name="doi-fetch"
        placeholder="e.g., https://doi.org/10.1234/example"
        value=""
      />
    </label>

    <select name="citation_type" id="citation_type">
      <option value="">Citation Type</option>
      <option value="article">Article</option>
      <option value="book">Book</option>
      <option value="booklet">Booklet</option>
      <option value="conference">Conference</option>
      <option value="inbook">Inbook</option>
      <option value="incollection">Incollection</option>
      <option value="inproceedings">Inproceedings</option>
      <option value="manual">Manual</option>
      <option value="mastersthesis">Masters Thesis</option>
      <option value="misc">Misc</option>
      <option value="phdthesis">PhD Thesis</option>
      <option value="proceedings">Proceedings</option>
      <option value="techreport">Tech Report</option>
      <option value="unpublished">Unpublished</option>
    </select>
    <label for="author"
      >Author: <input id="author" type="text" name="author"
    /></label>
    <label for="title"
      >Title: <input id="title" type="text" name="title"
    /></label>
    <label for="publisher"
      >Publisher: <input id="publisher" type="text" name="publisher"
    /></label>
    <label for="year">Year: <input id="year" type="text" name="year" /></label>
    <label for="doi"> DOI: <input id="doi" type="text" name="doi" /> </label>

    <div class="form-buttons">
      <button id="add_citation_button" class="primary" type="submit">
        Add
      </button>
      <a href="/">
        <button type="button" class="secondary">Cancel</button>
      </a>
    </div>
  </div>
</form>

<script>
  const doiFetchInput = document.getElementById("doi-fetch");
  const doiMessage = document.getElementById("doi-message");

  const displayMessage = (message, type) => {
    doiMessage.textContent = message;
    doiMessage.className = `${type}-message`;
    if (type === "error") {
      setTimeout(() => {
        doiMessage.textContent = "";
        doiMessage.className = "";
      }, 3000);
    }
  };

  const mapCitationType = (apiType) => {
    if (!apiType) return "";
    const lowerType = apiType.toLowerCase();

    if (lowerType.includes("proceedings")) return "proceedings";
    if (lowerType.includes("thesis") || lowerType.includes("dissertation"))
      return "phdthesis";
    if (lowerType.includes("report")) return "techreport";
    if (lowerType.includes("manual")) return "manual";
    if (lowerType.includes("book")) return "book";
    if (lowerType.includes("booklet")) return "booklet";
    if (lowerType.includes("conference")) return "conference";
    if (lowerType.includes("inbook")) return "inbook";
    if (lowerType.includes("incollection")) return "incollection";
    if (lowerType.includes("inproceedings")) return "inproceedings";
    if (lowerType.includes("unpublished")) return "unpublished";
    if (lowerType.includes("article")) return "article";

    return "misc";
  };

  const fetchDoiData = async (doi) => {
    if (!doi) {
      return;
    }

    try {
      displayMessage("Fetching doi info...", "pending");
      const response = await fetch(`https://api.crossref.org/works/${doi}`);

      if (response.status === 404) {
        displayMessage("DOI not found!", "error");
        return;
      }

      const data = await response.json();
      const { type, author, title, publisher, created, DOI } = data.message;

      document.getElementById("citation_type").value = mapCitationType(type);
      document.getElementById("author").value =
        author?.map((a) => a.given + " " + a.family).join(", ") || "";
      document.getElementById("title").value = title?.[0] || "";
      document.getElementById("publisher").value = publisher || "";
      document.getElementById("year").value =
        created?.["date-parts"]?.[0]?.[0] || "";
      document.getElementById("doi").value = DOI || "";

      displayMessage("âœ“ Citation loaded from DOI!", "success");
    } catch (error) {
      displayMessage("Error fetching DOI. Please try again.", "error");
    }
  };

  doiFetchInput.addEventListener("blur", async (event) => {
    let doi = event.target.value.trim();
    await fetchDoiData(doi);
  });
</script>

{% endblock %}
